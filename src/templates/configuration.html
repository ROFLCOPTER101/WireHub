<html lang="en">
{% with title=title%}
    {% include "header.html"%}
{% endwith %}
<body>
	{% include "navbar.html" %}
	<div class="container-fluid">
		{% include "sidebar.html" %}
        <div class="col-md-9 ml-sm-auto col-lg-10 px-md-4 mt-4 mb-4">
            <div class="form-group">
                <input type="text" class="form-control" id="search_peer_textbox" placeholder="Search Peer..." value="" style="display: none">
            </div>
        </div>
		<div id="config_body">
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4 mt-4 mb-4">
                <div class="info mt-4">
                    <div id="config_info_alert"></div>
                    <div class="row">
                        <div class="col">
                            <small class="text-muted"><strong>CONFIGURATION</strong></small>
                            <h1 class="mb-3"><samp id="conf_name">{{ title }}</samp></h1>
                        </div>
                        <div class="col">
                            <small class="text-muted"><strong>ACTION</strong></small><br>
                            <div id="conf_status_btn"></div>
                            <div class="spinner-border text-primary" role="status" style="display: none; margin-top: 10px">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div class="w-100"></div>
                        <div class="col">
                            <small class="text-muted"><strong>STATUS</strong></small>
                            <h6 style="text-transform: uppercase;" id="conf_status"></h6>
                        </div>
                        <div class="col">
                            <small class="text-muted"><strong>CONNECTED PEERS</strong></small>
                            <h6 style="text-transform: uppercase;" id="conf_connected_peers"></h6>
                        </div>
                        <div class="col-sm">
                            <small class="text-muted"><strong>TOTAL DATA USAGE</strong></small>
                            <h6 style="text-transform: uppercase;" id="conf_total_data_usage"></h6>
                        </div>
                        <div class="col-sm">
                            <small class="text-muted"><strong>TOTAL RECEIVED</strong></small>
                            <h6 style="text-transform: uppercase;" id="conf_total_data_received"></h6>
                        </div>
                        <div class="col-sm">
                            <small class="text-muted"><strong>TOTAL SENT</strong></small>
                            <h6 style="text-transform: uppercase;" id="conf_total_data_sent"></h6>
                        </div>
                        <div class="w-100"></div>
                        <div class="col-sm">
                            <small class="text-muted">
                                <strong>PUBLIC KEY</strong>
                                <strong style="margin-left: auto!important; opacity: 0; transition: 0.2s ease-in-out" class="text-primary">CLICK TO COPY</strong>
                            </small>
                            <h6><samp class="key" id="conf_public_key"></samp></h6>
                        </div>
                        <div class="col-sm">
                            <small class="text-muted"><strong>LISTEN PORT</strong></small>
                            <h6 style="text-transform: uppercase;"><samp id="conf_listen_port"></samp></h6>
                        </div>
                         <div class="col-sm">
                            <small class="text-muted"><strong>ADDRESS</strong></small>
                            <h6 style="text-transform: uppercase;"><samp id="conf_address"></samp></h6>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="button-div mb-3">
                    <div class="row">
                        <div class="col-sm">
                             <div class="form-group">
                                <label for="sort_by_dropdown"><small class="text-muted">Sort Peers By</small></label>
                                <select class="form-control" id="sort_by_dropdown">
                                    <option value="status">Status</option>
                                    <option value="name">Name</option>
                                    <option value="allowed_ip">Allowed IP</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm">
                            <div class="form-group">
                                <label><small class="text-muted">Refresh Interval</small></label><br>
                                <div class="btn-group interval-btn-group" role="group" style="width: 100%">
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary btn-group-label refresh"><i class="bi bi-arrow-repeat"></i></button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="5000">5s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="10000">10s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="30000">30s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="60000">1m</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm">
                            <div class="form-group">
                                <label><small class="text-muted">Display Mode</small></label><br>
                                <div class="btn-group display-btn-group" role="group" style="width: 100%">
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary display_mode" data-display-mode="grid"><i class="bi bi-grid-fill" style="font-size: 1.5rem;"></i></button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary display_mode" data-display-mode="list"><i class="bi bi-list" style="font-size: 1.5rem;"></i></button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary add_btn" data-toggle="modal" data-target="#add_modal">
                            <i class="bi bi-plus-circle-fill" style=""></i> Add Peer
                        </button>
                    </div>
                </div>
                <div class="row peer_list"></div>
            </main>
        </div>
	</div>
	<div class="modal fade" id="add_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">Add a new peer</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div id="add_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form id="add_peer_form">
                        <div class="alert alert-warning" role="alert" style="font-size: 0.8rem">
                            To generate QR code for this new peer, you need to provide the private key, or use the generated key. If you don't need the QR code, simply remove the private key and insert your existed public key.
                        </div>
                        <div class="form-group">
                            <div>
                                <label for="private_key">Private Key</label>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="private_key" aria-describedby="public_key">
                                <div class="input-group-append">
                                   <button type="button" class="btn btn-danger" id="re_generate_key"><i class="bi bi-arrow-repeat"></i></button>
                                </div>
                            </div>
                        </div>
						<div class="form-group">
							<label for="public_key">Public Key <code>(Required)</code></label>
							<input type="text" class="form-control" id="public_key" aria-describedby="public_key" disabled>
						</div>
                        <div class="row">
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_name">Name</label>
                                    <input type="text" class="form-control" id="new_add_name">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="allowed_ips">Allowed IPs <code>(Required)</code></label>
                                    <input type="text" class="form-control" id="allowed_ips">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_DNS">DNS <code>(Required)</code></label>
                                    <input type="text" class="form-control" id="new_add_DNS" value="{{ DNS }}">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_endpoint_allowed_ip">Endpoint Allowed IPs <code>(Required)</code></label>
                                    <input type="text" class="form-control" id="new_add_endpoint_allowed_ip" value="{{ endpoint_allowed_ip }}">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_MTU">MTU</label>
                                    <input type="text" class="form-control" id="new_add_MTU" value="{{ mtu }}">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_keep_alive">Persistent keepalive</label>
                                    <input type="text" class="form-control" id="new_add_keep_alive" value="{{ keep_alive }}">
                                </div>
                            </div>
                        </div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="save_peer" conf_id={{conf_data['name']}}>Save</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="delete_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">Are you sure to delete this peer?</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div id="remove_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
					<h6>This action is not reversible.</h6>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
					<button type="button" class="btn btn-danger" id="delete_peer" conf_id={{conf_data['name']}} peer_id="">Yes</button>
				</div>
			</div>
		</div>
	</div>

    <div class="modal fade" id="setting_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true" conf_id={{conf_data['name']}} peer_id="">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="peer_name"></h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
                    <div id="setting_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
                    <div>
                      <label for="peer_private_key_textbox" class="form-label">Private Key <code>(Required for QR Code and download)</code></label>
                      <input type="password" class="form-control" id="peer_private_key_textbox" style="padding-right: 40px">
                      <a class="peer_private_key_textbox_switch"><i class="bi bi-eye-fill"></i></a>
                    </div>
                    <hr>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_name_textbox" class="form-label">Name</label>
                              <input type="text" class="form-control" id="peer_name_textbox" placeholder="">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_allowed_ip_textbox" class="form-label">Allowed IPs <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_allowed_ip_textbox">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_DNS_textbox" class="form-label">DNS <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_DNS_textbox">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_endpoint_allowed_ips" class="form-label">Endpoint Allowed IPs <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_endpoint_allowed_ips">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_mtu" class="form-label">MTU</label>
                              <input type="text" class="form-control" id="peer_mtu">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_keep_alive" class="form-label">Persistent Keepalive</label>
                              <input type="text" class="form-control" id="peer_keep_alive">
                            </div>
                        </div>
                    </div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="save_peer_setting" conf_id={{conf_data['name']}} peer_id="">Save</button>
				</div>
			</div>
		</div>
	</div>

    <div class="modal fade" id="qrcode_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="peer_name">QR Code</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
                    <img src="" id="qrcode_img" style="width: 100%">
				</div>
			</div>
		</div>
	</div>

    <div class="position-fixed top-0 right-0 p-3" style="z-index: 5; right: 0; top: 50px;">
          <div id="alertToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000">
            <div class="toast-header">
                  <strong class="mr-auto">Wireguard Dashboard</strong>
                  <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
            </div>
            <div class="toast-body">
            </div>
          </div>
    </div>
    {% include "tools.html" %}
</body>
{% include "footer.html" %}
<script>
    let load_timeout;
    let load_interval = 0;
    var conf_name = "{{ conf_data['name'] }}"
    $(".sb-"+conf_name+"-url").addClass("active");
    // Progress Bar
    let bar = $(".progress-bar")
    function startProgressBar(){
        bar.css("width","0%")
        bar.css("opacity", "100")
        bar.css("background", "rgb(255,69,69)")
        bar.css("background", "linear-gradient(145deg, rgba(255,69,69,1) 0%, rgba(0,115,186,1) 100%)")
        bar.css("width","25%")
        setTimeout(function(){
            stillLoadingProgressBar();
        },300)
    }
    function stillLoadingProgressBar(){
        bar.css("transition", "3s ease-in-out")
        bar.css("width", "75%")
    }
    function endProgressBar(){
        bar.css("transition", "0.3s ease-in-out")
        bar.css("width","100%")
        setTimeout(function(){
            bar.css("opacity", "0")
        },250)

    }
	function load_data(search){
        startProgressBar()
        let result = '';
		$.ajax({
			method: "GET",
			url: "/get_config/"+conf_name+"?search="+encodeURIComponent(search),
			headers:{
				"Content-Type": "application/json"
			},
			success: function (response){
                {# Check all status #}
                if (response["listen_port"] === "" && response["status"] === "stopped"){
                    $("config_info_alert").append('<div class="alert alert-warning" role="alert">Peer QR Code and configuration file download required a specified <strong>Listen Port</strong>.</div>')
                }
                if (response["conf_address"] === "N/A"){
                    $("config_info_alert").append('<div class="alert alert-warning" role="alert">Configuration <strong>Address</strong> need to be specified to have peers connect to it.</div>')
                }
                {# Status Button #}
                if (response["checked"] === "checked"){
                    $("#conf_status_btn").html('<a href="#" id="'+response["name"]+'" '+response["checked"]+' class="switch text-primary"><i class="bi bi-toggle2-on"></i> ON</a>');
                }else{
                    $("#conf_status_btn").html('<a href="#" id="'+response["name"]+'" '+response["checked"]+' class="switch text-primary"><i class="bi bi-toggle2-off"></i> OFF</a>');
                }
                $("#sort_by_dropdown option").removeAttr("selected");
                $("#sort_by_dropdown option[value="+response["sort_tag"]+"]").attr("selected", "selected");
                $(".interval-btn-group button").removeClass("active");
                $("button[data-refresh-interval="+response["dashboard_refresh_interval"]+"]").addClass("active");
                $(".display-btn-group button").removeClass("active");
                $("button[data-display-mode="+response["peer_display_mode"]+"]").addClass("active");



                $("#conf_status").html(response["status"]+'<span class="dot dot-'+response["status"]+'"></span>');
                $("#conf_connected_peers").html(response["running_peer"]);
                $("#conf_total_data_usage").html(response["total_data_usage"][0]+" GB");
                $("#conf_total_data_received").html(response["total_data_usage"][1]+" GB");
                $("#conf_total_data_sent").html(response["total_data_usage"][2]+" GB");
                $("#conf_public_key").html(response["public_key"]);
                $("#conf_listen_port").html(response["listen_port"] === "" ? "N/A":response["listen_port"]);
                $("#conf_address").html(response["conf_address"]);

                if (response["peer_data"].length === 0){
                    $(".peer_list").html('<div class="col-12" style="text-align: center; margin-top: 1.5rem"><h3 class="text-muted">Oops! No peers found ‘︿’</h3></div>');
                }else{
                    let display_mode = response["peer_display_mode"] === "list" ? "col-12" : "col-sm-6 col-lg-4";
                    response["peer_data"].forEach(function(peer){
                        let spliter = '<div class="w-100"></div>';
                        let peer_name = '<div class="col-sm"><h4>'+ (peer["name"] === "" ? "Untitled" : peer["name"]) +'</h4></div>';
                        let peer_status = '<div class="col-6"><small class="text-muted"><strong>STATUS</strong></small> <h6 style="text-transform: uppercase;" class="mb-2 h6-dot-'+peer["status"]+'"><span class="dot dot-'+peer["status"]+'" style="margin-left: 0 !important;margin-top: 5px"></span></h6></div>'
                        let peer_transfer = '<div class="col-6 peer_data_group" style="text-align: right"> <small class="text-muted"><strong>TRANSFER</strong></small> <p class="text-primary" style="text-transform: uppercase; margin-bottom: 0;"><small><i class="bi bi-arrow-down-right"></i>'+peer["total_receive"]+' GB</small></p> <p class="text-success" style="text-transform: uppercase; margin-bottom: 0"><small><i class="bi bi-arrow-up-right"></i> '+peer["total_sent"]+' GB</small></p> </div>'
                        let peer_key = '<div class="col-sm"><small class="text-muted" style="display: flex"><strong>PEER</strong><strong style="margin-left: auto!important; opacity: 0; transition: 0.2s ease-in-out" class="text-primary">CLICK TO COPY</strong></small> <h6><samp class="ml-auto key">'+peer["id"]+'</samp></h6></div>';
                        let peer_allowed_ip = '<div class="col-sm"><small class="text-muted"><strong>ALLOWED IP</strong></small><h6 style="text-transform: uppercase;">'+peer["allowed_ip"]+'</h6></div>';
                        let peer_latest_handshake = '<div class="col-sm"> <small class="text-muted"><strong>LATEST HANDSHAKE</strong></small> <h6 style="text-transform: uppercase;">'+peer['latest_handshake']+'</h6> </div>';
                        let peer_endpoint = '<div class="col-sm"><small class="text-muted"><strong>END POINT</strong></small><h6 style="text-transform: uppercase;">'+peer["endpoint"]+'</h6></div>';
                        let peer_control = '<div class="col-sm"><hr><div class="button-group" style="display:flex"> <button type="button" class="btn btn-outline-primary btn-setting-peer btn-control" id="'+peer["id"]+'" data-toggle="modal"><i class="bi bi-gear-fill"></i></button> <button type="button" class="btn btn-outline-danger btn-delete-peer btn-control" id="'+peer["id"]+'" data-toggle="modal"><i class="bi bi-x-circle-fill"></i></button>';
                        if (peer["private_key"] !== ""){
                            peer_control += '<div class="share_peer_btn_group" style="margin-left: auto !important; display: inline"><button type="button" class="btn btn-outline-success btn-qrcode-peer btn-control" img_src="/qrcode/'+response['name']+'?id='+encodeURIComponent(peer["id"])+'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 19px;" fill="#28a745"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM13 13h2v2h-2zM15 15h2v2h-2zM13 17h2v2h-2zM17 17h2v2h-2zM19 19h2v2h-2zM15 19h2v2h-2zM17 13h2v2h-2zM19 15h2v2h-2z"/></svg></button><a href="/download/'+response["name"]+'?id='+encodeURIComponent(peer["id"])+'" class="btn btn-outline-info btn-download-peer btn-control"><i class="bi bi-download"></i></a></div>';
                        }
                        peer_control += '</div>';
                        let html = '<div class="'+display_mode+'">' +
                                        '<div class="card mb-3 card-'+peer["status"]+'">' +
                                            '<div class="card-body">' +
                                             '<div class="row">'
                                                + peer_name
                                                + spliter
                                                + peer_status
                                                + peer_transfer
                                                + peer_key
                                                + peer_allowed_ip
                                                + peer_latest_handshake
                                                + spliter
                                                + peer_endpoint
                                                + spliter
                                                + peer_control
                                            + '</div>' +
                                        '</div></div>' +
                                    '</div></div>';
                        result += html;
                    })
                    $(".peer_list").html(result);
                    if (response["dashboard_refresh_interval"] !== load_interval){
                        load_interval = response["dashboard_refresh_interval"];
                        clearInterval(load_timeout);
                        load_timeout = setInterval(function (){
                            load_data($('#search_peer_textbox').val());
                        },response["dashboard_refresh_interval"])
                    }
                }
				{#$("#config_body").html(response);#}
                $("#search_peer_textbox").css("display", "block")
                endProgressBar()
			}
		})
	}
	$(function(){
		load_data($('#search_peer_textbox').val());
		{#setInterval(function(){#}
		{#	load_data($('#search_peer_textbox').val());#}
		{#}, {{dashboard_refresh_interval}})#}
	});
</script>
<script src="{{ url_for('static',filename='js/configuration.js') }}"></script>
</html>	